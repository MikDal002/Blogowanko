---
title: "Własny szablon projektu .Net"
date: 2021-09-10
draft: false
image: cover.jpg
description: "Dziś o tym, co powtarzałem dotychczas najczęściej, czyli jak utworzyć projekt i mieć od razu zainstalowane wszystkie ulubione biblioteki. 
Inaczej mówiąc: o tym, jak zrobić własny szablon projektu, który możemy wykorzystać wraz z komendą dotnet new lub w Visual Studio"
categories: 
    - ".Net"
    - "Narzędzia"
tags:
    - "C-sharp"
    - "csproj"
    - "templates"
---

= Własny szablon projektu
:toc: 

Jeśli szukasz konkretnych przykładów lub bardziej zaawansowanych rozwiązań to zapraszam do tego repozytorium Microsoftu: https://github.com/dotnet/dotnet-template-samples.

== Dwa sposoby tworzenia szablonów 
Wyróżniam dwa sposoby na tworzenie szablonów:

* *prosty* - gdzie wrzucamy do katalogu pliki, których chcemy używać, a polecenie dotnet new po prostu przekopiuje pliki w nowe miejsce i ewentualnie zmieni ich zawartosć,
* *Nugetowy* - gdzie możemy utworzyć własną paczkę z szablonami i swobodnie ja dystrybuować w postaci nuget'a. Do tego oferuje ona możliwość załadowania wielu szablonów w jedną paczkę. 

=== Prosty 

Aby utworzyć prosty szablon należy: 

. Utworzyć katalog, w którym znajdą się rzeczy, które trafią do szablonu – nazwijmy go `simplest` – będzie to nasz bieżący katalog roboczy. 

. Wewnątrz katalogu roboczego utwórz następny o nazwie `.template.config`, a wewnątrz katalogu `.template.config` utwórz plik o nazwie `template.json` 
+
[example]
****
Po wykonaniu tych dwóch kroków na pulpicie powinniśmy otrzymać taką strukturę katalogów
[source]
.Szablonowa struktura plików
----
Pulpit/
└── simplest/
    ├── Installer.cs
    └── PersonComponent.Core.csproj
----

****
+

. Do pliku `template.json` wklej zawartość: 
+
****
[source,json]
.Plik konfigurujący nasz szablon
----
include::src/simplest/.template.config/template.json[]
----
**** 

. Do katalogu roboczego dodaj dowolny plik, na przykład plik projektu  `PersonComponent.Core.csproj` oraz plik klasy C# o nazwie `Installer.cs` o treści:
+
****
[source,xml]
.Przykładowy plik projektu PersonComponent.Core.csproj
----
include::src/simplest/PersonComponent.Core.csproj[]
----

[source,csharp]
.Przykładowy plik klasy C# Installer.cs
----
include::src/simplest/Installer.cs[]
----
****

. Teraz przejdź w konsoli do katalogu nadrzędnego dla katalogu roboczego i wywołaj tam polecenie `dotnet new -i .\simplest\`. Powinieneś na końcu zobaczyć wypis:
+
****
[source,console]
----
Nazwa szablonu                 Skrócona nazwa  Język  Tagi
-----------------------------  --------------  -----  --------------
Program It Once core template  ztr-core               Common/Console
----

Zwróć uwagę jak z tym, co wyświetla się na ekranie, korelują wartości `shortName`, `name` oraz `classifications` z pliku template.json. 
Szczegółowo rozpiszę się o tym później.
****

. Teraz największa magia.
Utwórz gdzieś indziej nowy katalog o nazwie `MójProjekt` i przejdź do niego w konsoli, gdzie wywołaj komendę `dotnet new ztr-core`.
+
****
Zobaczysz, że do katalogu została skopiowana zawartość szablonu, ale ze zmienionymi nazwami! 

[source]
.Wynikowa struktura plików
----
Pulpit/
└── MójProjekt/
    ├── Installer.cs
    └── MójProjekt.Core.csproj
----

Dodatkowo zawartość pliku Installer.cs też została zmieniona! 
Jak to się stało? 
Otóż odpowiada za to linijka `"sourceName": "PersonComponent"` z pliku konfiguracyjnego, która wskazuje jaki ciąg znaków ma zostać zamieniony na nazwę _projektu_, którą podajemy podczas używania szablonu w komendzie `dotnet new ztr-core -n "MójProjekt"`. 
Ale my nie podaliśmy końcówki `-n MójProjekt` – ta została domyślnie wzięta z nazwy katalogu.

Silnik szablonów samodzielnie przeszuka wszystkie pliki, które zawiera i zamieni ciąg znaków `PersonComponent` na nazwę projektu. 
Nawet jeśli występuje ona w nazwie pliku. 
Możliwe jest jeszcze więcej modyfikacji, ale one wykraczają poza ten artykuł, a przykłady ich użycia znajdziesz w repozytorium podanym na samym początku. 

****

. Wadą tego rozwiązania jest to, że cały czas polega ono na katalogu źródłowym szablonu. 
Dodaj do katalogu `simplest` nowy plik `dumb.txt` nawet bez zawartości, a zobaczysz, że przy ponownym wywołaniu metody `dotnet new ztr-core` ten również zostanie przekopiowany. 

. Teraz usuń lub zmień nazwę katalogu źródłowego (`simplest`) i spróbuj ponownie utworzyć nowy projekt (`dotnet new ztr-core`)
+
****
[source,console]
----
PS> dotnet new ztr-core
Nie można zlokalizować określonej zawartości szablonu, ponieważ pamięć podręczna szablonu może być uszkodzona. Spróbuj uruchomić polecenie "dotnet Microsoft.TemplateEngine.Cli.CommandParsing.BaseCommandInput--debug:reinit", aby rozwiązać problem.
----

I wszystko przestaje działać.
Dlatego takie podejście jest dobre na początek, gdy poznajemy silniki oraz ewentualnie dla jakiś specyficznych lokalnych szablonów. 


WARNING: Jeszcze raz podkreślę, co zostało napisane powyżej. Szablonem prostym jest wszystko, co znajdzie się w katalogu źródłowym! A przeniesienie katalogu źródłowego powoduje, że przestanie on działać.

****

. Aby odinstalować szablon użyj polecenia `dotnet new -u «pełna ścieżka do szablonu»`
+
****
Co jeśli nie pamiętasz, gdzie jest twój szablon? 
Użyj polecenia `dotnet new -u` bez żadnych dodatkowych elementów. 
Wyświetli Ci się lista szablonów, które możesz odinstalować wraz z odpowiednim poleceniem: 

[source,console]
.Widok pomocy jak odinstalować szablony
----
PS> dotnet new -u
    C:\Users\md\Desktop\simplest
      Szablony:
         Program It Once core template (ztr-core)
      Polecenie odinstalowania:
   dotnet new --uninstall C:\Users\md\Desktop\simplest
----

Po czym wystarczy skopiować ostatnią linijkę wpisu dotyczącą szablonu, który chcemy usunąć i voilà – z powrotem mamy czysto.
****

=== Nugetowy

Nugetowy szablon ma dwie zasadnicze zalety:

* [*] Może być spakowany do postaci nuget'a,
* [*] Może być paczką szablonów, czyli zawierać w sobie wiele pojedynczych, całkowicie różnych szablonów dostarczanych w jednym pliku.

. Aby utworzyć taką paczkę, utwórz drzewo katalogów z plikami jak poniżej:
+
****
[source]
.Struktura katalogów szablonów do spakowania w formie nugetowej
----
MojaPaczkaSzablonów/
├── ZtrDotnetTemplates.csproj <1>
└── templates/
    ├── ConsoleTemplate/
    │   └── .template.config/
    │       └── template.json <2>
    └── CoreTemplate/
        └── .template.config/
        │   └── template.json <2>
        ├── Installer.cs <3>
        └── PersonComponent.Core.csproj <3>

----
<1> To plik projektu, który jest naszą paczką szablonów,
<2> to pliki opisujące dane szablon. Na każdy szablon musi przypadać jeden taki plik,
<3> pliki, które będą dołączone do naszych szablonów.

Katalog `ConsoleTemplate` zostawiam pusty (poza plikiem konfiguracyjnym) w celu ograniczenia rozmiaru tego przykładu.
****

. Uzupełnij plik projektu `ZtrDotnetTemplates.csproj`:
+
****
[source,xml]
.Zawartość pliku ZtrDotnetTemplates.csproj
----
include::src/more_functional/ZtrDotnetTemplates.csproj[]
----
<1> Zwróć uwagę na specyficzny typ projektu `Template`. Jest on niezbędny do poprawnego utworzenia paczki.
<2> W tym miejscu zaczynają się standardowe pola do opisu pakietu Nuget.
<3> `TargetFramework` w tym przypadku określa wersję .Net używaną do budowania paczki nugetowej z szablonami.
<4> Zwróć uwagę, że załączone będą wszystkie szablony znajdujące się w katalogu `templates` z wyjątkiem plików znajdujących się w katalogach `bin` i `obj`.

****

. Uzupełnij plik konfiguracyjny szablonu konsolowego `templates/console/.template.config/template.json`
+
****
.Zawartość pliku console/.template.config/template.json
[source,json]
----
include::src/more_functional/templates/console/.template.config/template.json[]
----

Nie różni się on zbytnio od tego, co widzieliśmy w poprzednim przykładzie, z tym że tutaj dodałem informację na temat języka wykorzystywanego w szablonie. 

****

. Uzupełnij pliki `templates/core/.template.config/template.json`, `templates/core/Installer.cs` oraz `templates/core/PersonComponent.Core.csproj`
+
****
Pliki te są identyczne z tymi samymi, które zostały wypisane powyżej, dlatego tylko je tu wkleję bez dalszego omówienia.

[source,json]
.Plik templates/core/.template.config/template.json
----
include::src/more_functional/templates/core/.template.config/template.json[]
----

[source,xml]
.Plik templates/core/PersonComponent.Core.csproj
----
include::src/more_functional/templates/core/PersonComponent.Core.csproj[]
----

[source,csharp]
.Plik templates/core/Installer.cs
----
include::src/more_functional/templates/core/Installer.cs[]
----
****

. Zbuduj i zainstaluj nugeta!
+
****
W katalogu `MojaPaczkaSzablonów` uruchom polecenie `dotnet pack`.
Przejdź następnie do folderu `./bin/debug/`, a tam zobaczysz plik o nazwie `ZTR.Utilities.Templates.1.0.0.nupkg`. 
Aby zainstalować tę paczkę, skorzystaj z polecenia `dotnet new -i ZTR.Utilities.Templates.1.0.0.nupkg`.

[source,console]
.Proces budowania i instalacji paczki
----
~\MojaPaczkaSzalonów> dotnet pack
...
Pomyślnie utworzono pakiet "~\MojaPaczkaSzalonów\bin\Debug\ZTR.Utilities.Templates.1.0.0.nupkg".
~\MojaPaczkaSzalonów> cd .\bin\Debug\
~\MojaPaczkaSzalonów> dotnet new -i .\ZTR.Utilities.Templates.1.0.0.nupkg
Sukces: ZTR.Utilities.Templates::1.0.0 zainstalował następujące szablony:
Nazwa szablonu                    Skrócona nazwa  Język  Tagi
--------------------------------- --------------- -----  ----------------------
Program It Once Console template  ztr-console     [C#]   Common/Console
Program It Once core template     ztr-core        [C#]   Common/Console/Library
----

****

. Używaj!
+
****
Zainstalowanych pakietów używa się tak samo (np. poleceniem `dotnet new ztr-console`), z tym że teraz zmiana katalogu źródłowego nie psuje nam naszego szablonu!
Jeśli chcemy odinstalować paczkę, robimy to poleceniem `dotnet new -u .\ZTR.Utilities.Templates.1.0.0.nupkg`. 
****

== Podsumowanie

* Myślę, że własny szablon projektu może być bardzo przydatnym narzędziem, nie tylko w przypadku projektów .Netowych, ale także w innych rozwiązaniach, niezwiązanych z żadnym językiem programowania. 
* Pamiętaj, że ten artykuł to dopiero zalążek, a cały silnik szablonów ma jeszcze wiele możliwości, które możesz odkryć w linkach poniżej – znajdują się tam, między innymi, adresy repozytoriów związane z tym projektem. 
* Zwróć uwagę, że całość będzie jeszcze przyjemniejsza, gdy własne szablony połączysz CI/CD (np. na Githubie) co da Ci dostęp do twoich ulubionych wzorców niemalże wszędzie!


== Odnośniki 

* Github z przykładami https://github.com/dotnet/dotnet-template-samples - dobre miejsce do startu.
* Podstawowy link, który pokrótce wyjaśnia wszystko: https://docs.microsoft.com/en-us/dotnet/core/tools/custom-templates, nie jest on najczytelniejszy, ale przy drugim/trzecim podejściu można zrozumieć wszystko.
* Seria artykułów od MS. Zawiera tę samą treść co powyżej tylko bardziej uszczegółowioną: https://docs.microsoft.com/en-us/dotnet/core/tutorials/cli-templates-create-item-template.
* Github zawierający repo silnika szablonów: https://github.com/dotnet/templating - miejsce, gdzie możesz znaleźć dużo szczegółowych informacji.