---
title: "Nuke – wygodne CI/CD programu końcowego w C#"
date: 2022-06-12
draft: false
image: cover.jpg
description: "Nuke pozwala nam na proste opisanie procesu budowania i publikowania naszej aplikacji w języku C#. Niniejszy artykuł nie skończy się na samym wprowadzeniu. Zamierzam pokazać Ci jak zbudować aplikację, uruchomić testy jednostkowe, wymusić odpowiednie pokrycie kodu oraz jak przygotować aplikację do publikacji. 
Opiszę również sposób przygotowania CI/CD dla Github Actions z uwzględnieniem parametrów pobierania sekretów repozytorium."

categories: 
    - "W okół kodu"
    - "CI/CD"
tags:
    - ".Net"
    - "CI/CD"
    - "Testy jednostkowe"
    - "Github Actions"
---
:toc: 
:experimental: true

== Wstęp
Wyobraź sobie, że całe CI/CD swojej aplikacji możesz opisać za pomocą C#.
Bez potrzeby nauki środowiska graficznego TeamCity, czy YAML'i GitHuba. 

Nuke jest jednym ze sposobów opisu budowania naszej aplikacji w języku C#. 
Jeżeli chcemy, aby nasz projekt był cały czas łatwo zarządzalny, musimy mieć sposób na opis wszystkich wymagań stawianych przed nim. 
I tak oto, możemy opisać:

1. (Czyszczenie) jak powinny wyglądać katalogi przed rozpoczęciem budowania projektu,
2. (Przygotowanie) jakich zależności potrzebuje nasza aplikacja do kompilacji,
3. (Budowanie) w jakiej kolejności budować poszczególne elementy,
4. (Testowanie) jak uruchamiać testy jednostkowe i jakie są nasze wymagania co do pokrycia nimi naszego kodu,
5. (Publikacja) jak spakować naszą aplikację i wysłać ją na środowisko produkcyjne. 

Nie jest to kompletna lista, tego, co możemy zrobić w trakcie procesu ciągłej integracji i dostarczania. 
Na pewno pokazuje ona podstawowe zagadnienia, przed którymi jesteśmy stawiani podczas wydawania kolejnej wersji naszego oprogramowania. 
I jak to w życiu bywa, jeśli czegoś nie zapiszemy, to pewno o tym zapomnimy.
A po co zapisywać coś na skrawku papieru, gdy można to zrobić za pomocą kodu, który wykona się sam? 

Wszystkie wyżej opisane kroki możemy opisywać w różnych językach.
Robimy to często w tak wyspecjalizowanych formach, jak projekty budujące na TeamCity, czy GitHub Actions. 
Nuke przekonał mnie tym, że nie muszę uczyć się tych wszystkich konfiguracji osobno – mogę opisać wszystko, co niezbędne za pomocą dobrze mi znanego języka C# i wykorzystywać tam, gdzie potrzebuję.
W przypadku GitHub Actions mogę bez problemu również wykorzystać raz napisany kod w wielu różnych przepływach, co stanowczo upraszcza pracę i testowanie.

== Wstępna konfiguracja z pomocą kreatora

Wstępną konfigurację naszego projektu warto zacząć od instalacji narzędzia Nuke, które stanowczo ułatwia pracę dewelopera.
Co ważne, nie jest ono niezbędne na serwerze budującym.

[source,powershell]
----
dotnet tool install Nuke.GlobalTool --global
----

.Widok konfiguratora Nuke
image::nuke-setup.png[]

1. Wybierz nazwę projektu budującego, 
2. Katalog, w którym będzie on zapisany,
3. Wersję Nuke,
4. Domyślne rozwiązanie, które będzie budowane,
5. Wybierz, czy chcesz, aby podstawowe polecenia budujące zostały już umieszczone w nowym projekcie. 
6. Wybierz środowisku, które będzie budować twoje rozwiązanie.
7. Wybierz miejsce, gdzie są umieszczone twoje projekty (w tym katalogu będzie przeprowadzane czyszczenie dodatkowe),
8. Wybierz, gdzie mają trafiać artefakty, czyli pliki wynikowe budowania, jak paczki nuget. 
9. Wybierz, gdzie są twoje projekty, które testują rozwiązanie.
10 Wybierz, czy używasz GitVersion. Ja wybrałem, że tak, jednak opis tego narzędzia znajdzie się w innym artykule.

Rezultatem takich wyborów, będzie klasa C#, która będzie wyglądać mniej więcej tak, jak poniżej.
Obok tego dostaniemy kilka plików build.sh i build.cmd i build.ps1, które pozwalają nam na budowę naszej aplikacji nawet w środowisku, które nie ma zainstalowanego środowiska .Net. 
Pojawi się również katalog `.nuke`, który przechowuje kilka ustawień.

.Widok klasy Build.cs
[source,csharp]
----
[CheckBuildProjectConfigurations]
[ShutdownDotNetAfterServerBuild]
class Build : NukeBuild
{
    public static int Main () => Execute<Build>(x => x.Compile);

    [Parameter("Configuration to build - Default is 'Debug' (local) or 'Release' (server)")]
    readonly Configuration Configuration = IsLocalBuild ? Configuration.Debug : Configuration.Release;

    [Solution] readonly Solution Solution;
    [GitRepository] readonly GitRepository GitRepository;
    [GitVersion] readonly GitVersion GitVersion;

    AbsolutePath SourceDirectory => RootDirectory / "src";
    AbsolutePath ArtifactsDirectory => RootDirectory / "artifacts";

    Target Clean => _ => _
        .Before(Restore)
        .Executes(() =>
        {
            SourceDirectory.GlobDirectories("**/bin", "**/obj").ForEach(DeleteDirectory);
            EnsureCleanDirectory(ArtifactsDirectory);
        });

    Target Restore => _ => _
        .Executes(() =>
        {
            DotNetRestore(s => s
                .SetProjectFile(Solution));
        });

    Target Compile => _ => _
        .DependsOn(Restore)
        .Executes(() =>
        {
            DotNetBuild(s => s
                .SetProjectFile(Solution)
                .SetConfiguration(Configuration)
                .SetAssemblyVersion(GitVersion.AssemblySemVer)
                .SetFileVersion(GitVersion.AssemblySemFileVer)
                .SetInformationalVersion(GitVersion.InformationalVersion)
                .EnableNoRestore());
        });

}
----

=== Jak budować projekt z pomocą Nuke

Projekt budujący Nuke możemy uruchomić przynajmniej na trzy sposoby:

==== Z konsoli

* __dotnet run__ -
Standardowym poleceniem `dotnet run` wywołanym w katalogu, gdzie znajduje się nasz projekt budujący (u mnie jest to katalog CICD).

* __Narzędzie nuke__ -
Jeśli zainstalowałeś wcześniej globalne narzędzie nuke, to możesz użyć również go.
Podejście to jest bardziej elastyczne, ponieważ zadziała niezależnie od katalogu, w którym je wywołasz. 
Potrafi ono samo znaleźć katalog główny rozwiązania i tam poszukać odpowiednich dojść.

Niezależnie od podejścia, pamiętaj, że przy uruchomieniu możesz podawać własne parametry uruchomieniowe. 
Możesz spróbować poprzez dodanie flagi `--Configuration Release`, co spowoduje zbudowanie aplikacji w trybie release. 

Więcej o definiowaniu własnych parametrów znajdziesz w dalszej części artykułu, w sekcji na temat CI/CD.

==== Plugin do Visual Studio 2022

Plugin do Visual Studio pozwala nam na wywoływanie akcji budowania prosto z IDE. 
Do tego dochodzi możliwość debugowania.

NOTE: Często, aby zmiany w kodzie budującym zostały zastosowane, niezbędne jest przebudowanie projektu. 
Samo budowanie, bez czyszczenia, rzadko daje efekty.

// Wyjaśnienie poszczególnych elementów raczej wolałbym dać w ramkach w tekście
.DependsOn()
****
`DependsOn` pozwala nam na określenie, jakie kroki trzeba wykonać przed wykonaniem wybranej akcji.
****

.Requires()
****
`Requires` pozwala określić nam, wymagania niezbędne do uruchomienia danej akcji. 
Jeśli, któryś z warunków nie będzie spełniony, zostanie wyświetlony błąd a cała procedura przerwana.
****

.Atrybut [Parameter]
****
Atrybut `Parameter` pozwala nam jasno określić parametry konfiguracyjne naszego procesu budującego. 
Daje on nam możliwość ustawienia opisu, wartości domyślnej.
Co ważne, wartości oznaczone atrybutem `Parameter` mogą być pozyskane zarówno z wiersza poleceń, przy uruchomieniu programu budującego, jak i ze zmiennych środowiskowyhc.
****

.Secret()
****
Oznaczenie parametru jako `Secret` spowoduje, że jego wartość nie zostanie wyświetlona w trakcie precesu budującego.
****

.CombineWith()
****
`CombineWith` pozwala nam na proste tworzenie kombinacji budowania. 
Kopiuje on konfigurację i pozwala na zmianę poszczególnych parametrów na podstawie dostarczonej kolekcji.
****

== Testy jednostkowe

Testy jednostkowe są niezbędnym elementem, jeśli chcemy utrzymać wysoką jakość naszego projektu oraz łatwość jego rozwoju w dłuższym czasie. 

== Pokrycie testami jednostkowymi

Pokrycie testami jednostkowymi jest badane za pomocą `Coverlet`, które jest domyślnie używane przez środowisko `dotnet test`.
Jednak jego poprawne użycie zajęło mi na prawdę sporo czasu. 
Aby móc z niego skorzystać musisz zainstalować odpowiednia paczkę:

[source,powershell]
----
nuke :add-package coverlet.console --version 3.1.2
# lub, jeśli nie zainstalowałeś narzędzia nuke
dotnet tool install --global coverlet.console --version 3.1.2
----

Największym problemem, okazało się wymuszenie odpowiedniego pokrycia testami.
Tylko jedna, z wielu testowanych przeze mnie konfiguracji, działa, to jest, zwraca błąd, gdy pokrycie testami jest niższe niż wskazane.

Nie użyłem DotCover, ponieważ nie jestem pewien, czy mogę go wykrzystywać w każdym projekcie.

WARNING: Działa tylko na Windows.

== Raport z testów jednostkowych

Raport ułatwi nam śledzenie, które moduły naszej aplikacji są testowane w najwyższym stopniu, a które w najniższym.
Istnieją także platformy, które potafią zrobić z nich większy użytek

== Publikowanie z wysyłką do Netlify jako przykład CI/CD.

#TODO: W tej sekcji powinno nastąpić opisanie parametrów#

Jako przykład pełnego CI/CD pokażę publikowanie projektu blazorowego do usługi Netlify, dzięki czemu, aplikacja Web Assembly będzie dostępna w Internecie.

Przykłady publikowania paczek nuget są łatwo dostępne w Internecie #TODO: Dodać przykładowy link!#, a moje podejście do sprawy pokażę w następnej części tej serii artykułów.

== Github Actions

Wszelką konfigurację github action robimy za pomocą atrybutu.

=== Dla pull requestów

NOTE: Nie zapomnij dodać definicji parametrów pobieranych z sekretów do pliku YAML. 

=== Dla CI/CD.

Proces budowania dla CI/CD chcemy, aby był uruchamiany tylko po poprawnym połączeniu z gałęzią master. 

== Opis dodatkowy
`build.ps1 --help`
`build.ps1 --plan`


=== Budowanie równoległe niektórych kroków
=== Logowanie Serilog.Warning()
=== Łączenie ścieżek do pliku za pomocą operatora /

== Podsumowanie

=== Minusy
Słaba dokumentacja. 
Szukanie zawsze trzeba wykonywać w dwóch kierunkach: 1) jak to powinno być zrobione natywnie za pomocą danego narzędzia, 2) jak to zrobic w Nuke. 
Mogłoby być zdecydowanie więcej przykładów.


Photo by https://unsplash.com/es/@burgessbadass?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText[Burgess Milner] on https://unsplash.com/s/photos/nuke?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText[Unsplash].
