---
title: Coverlet - exclusion of code coverage study by attribute
date: 2022-07-31
description: "In this note, I will show how to exclude specific classes from the code coverage and add the appropriate configuration to Nuke."
draft: false
categories:
    - Side notes
    - "Around the code"
    - "CI/CD"
tags:
    - ".Net"
    - "CI/CD"
    - "Unit tests"
    - "Code coverage"
series: 
    - "Nuke"
---

== Exclusion by attribute (ExcludeByAttribute)

When I was looking for 100% code coverage with unit tests, I faced the problem of how to exclude automatically generated code. 
Unfortunately, this information was terribly hard for me to find, so I am sharing it here. 

As the documentation shows, each attribute intended for exclusion must be passed separately:

[source,bash]
----
--exclude-by-attribute 'Obsolete' --exclude-by-attribute'GeneratedCode' --exclude-by-attribute 'CompilerGenerated'
----

More holistic example:

[source,bash]
----
coverlet /path/to/test-assembly.dll --target "dotnet" --targetargs "test /path/to/test-project --no-build" --exclude-by-attribute 'Obsolete' --exclude-by-attribute'GeneratedCode' 
----

== Nuke

To add an exclusion to Nuke, you need to modify the parameters of the code coverage. 
Taking a piece of code from link:{{% ref "/programowanie/w-okol-kodu/dotnet-nuke-wygodne-budowanie-cz-02/index.adoc" %}}[the second part about Nuke], one line would need to be added:

[source,bash,highlight=9]
----
CoverletSettings PrepareCoverageSettingsForCoveringProject(Project project, CoverletSettings settings,
    DotNetTestSettings coverageTestSettings, ref string previousCoverageFileResult)
{
    var assemblyPath = FindAssemblyForProject(project);
    var coverageResultDirectory = TestResultDirectory / project.Name;

    settings = settings
        .SetAssembly(assemblyPath)
        .SetProcessArgumentConfigurator(_ => _.Add(@"--exclude-by-attribute CompilerGeneratedAttribute --exclude-by-attribute GeneratedCodeAttribute")) // <1>
        .SetOutput(coverageResultDirectory + "/")
        .SetTargetSettings(coverageTestSettings
            .EnableNoBuild()
            .SetProjectFile(project));

    settings = MergeCoverageResultsWithPreviousRun(previousCoverageFileResult, settings);
    previousCoverageFileResult = SetThresholdForLastRun(project, coverageResultDirectory, ref settings);

    return settings;
}
----

<1> This one line is enough to exclude code marked with `CompilerGeneratedAttribute` and `GeneratedCodeAttribute` attributes.